<div class="vacancies-list-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Vacantes</h1>
    <button mat-flat-button color="primary" (click)="openCreateDialog()">
      <mat-icon>add</mat-icon>
      Nueva Vacante
    </button>
  </div>

  <!-- Filters -->
  <div class="filters-card">
    <div class="filters-row">
      <!-- Search -->
      <mat-form-field appearance="outline" class="filter-field filter-search">
        <mat-label>Buscar título</mat-label>
        <input
          matInput
          placeholder="Título del puesto..."
          [ngModel]="searchFilter()"
          (ngModelChange)="searchFilter.set($event)"
          (keyup.enter)="applyFilters()"
        />
        <mat-icon matPrefix>search</mat-icon>
      </mat-form-field>

      <!-- Status -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Estado</mat-label>
        <mat-select
          [ngModel]="statusFilter()"
          (ngModelChange)="statusFilter.set($event); applyFilters()"
        >
          @for (option of statusOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Pipeline -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Pipeline</mat-label>
        <mat-select
          [ngModel]="pipelineFilter()"
          (ngModelChange)="pipelineFilter.set($event); applyFilters()"
        >
          @for (option of pipelineOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Source -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Fuente</mat-label>
        <mat-select
          [ngModel]="sourceFilter()"
          (ngModelChange)="sourceFilter.set($event); applyFilters()"
        >
          @for (option of sourceOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- US State -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Estado (US)</mat-label>
        <mat-select
          [ngModel]="stateFilter()"
          (ngModelChange)="stateFilter.set($event); applyFilters()"
        >
          @for (state of usStates; track state.value) {
            <mat-option [value]="state.value">{{ state.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Company -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Empresa</mat-label>
        <input
          matInput
          placeholder="Buscar empresa..."
          [ngModel]="companyFilter()"
          (ngModelChange)="companyFilter.set($event)"
          (keyup.enter)="applyFilters()"
        />
      </mat-form-field>

      <!-- Date From -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Desde</mat-label>
        <input
          matInput
          type="date"
          [ngModel]="dateFrom()"
          (ngModelChange)="dateFrom.set($event)"
          (change)="applyFilters()"
        />
      </mat-form-field>

      <!-- Date To -->
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Hasta</mat-label>
        <input
          matInput
          type="date"
          [ngModel]="dateTo()"
          (ngModelChange)="dateTo.set($event)"
          (change)="applyFilters()"
        />
      </mat-form-field>

      <!-- Comercial (Assigned To) -->
      <div class="filter-group-with-btn">
        <mat-form-field appearance="outline" class="filter-field filter-assigned">
          <mat-label>Comercial</mat-label>
          <input
            matInput
            placeholder="Nombre comercial..."
            [ngModel]="assignedFilter()"
            (ngModelChange)="assignedFilter.set($event)"
            [disabled]="myAssignmentsActive()"
            (keyup.enter)="applyFilters()"
          />
          <mat-icon matPrefix>person</mat-icon>
        </mat-form-field>
        <button
          mat-icon-button
          [color]="myAssignmentsActive() ? 'primary' : ''"
          (click)="toggleMyAssignments()"
          [title]="myAssignmentsActive() ? 'Ver todos' : 'Ver mis asignaciones'"
          class="assigned-toggle-btn"
        >
          <mat-icon>{{ myAssignmentsActive() ? 'person' : 'person_outline' }}</mat-icon>
        </button>
      </div>

      <!-- Clear Filters -->
      <button mat-stroked-button (click)="clearFilters()" class="clear-btn">Limpiar</button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-card">
    <!-- Table Header -->
    <div class="table-header">
      <span class="table-count">{{ paginationInfo() }}</span>
    </div>

    <!-- Loading Spinner -->
    @if (isLoading()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    } @else {
      <!-- Data Table -->
      <table mat-table [dataSource]="vacancies()" class="vacancies-table">
        <!-- Job Title Column -->
        <ng-container matColumnDef="jobTitle">
          <th mat-header-cell *matHeaderCellDef>Título</th>
          <td mat-cell *matCellDef="let vacancy">
            <span class="job-title">{{ vacancy.jobTitle }}</span>
          </td>
        </ng-container>

        <!-- Company Column -->
        <ng-container matColumnDef="companyName">
          <th mat-header-cell *matHeaderCellDef>Empresa</th>
          <td mat-cell *matCellDef="let vacancy">
            <a class="company-link" [routerLink]="['/companies', vacancy.companyId]">
              {{ vacancy.companyName }}
            </a>
          </td>
        </ng-container>

        <!-- Location Column -->
        <ng-container matColumnDef="location">
          <th mat-header-cell *matHeaderCellDef>Ubicación</th>
          <td mat-cell *matCellDef="let vacancy">{{ vacancy.location }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let vacancy">
            <app-status-badge [status]="vacancy.status" />
          </td>
        </ng-container>

        <!-- Assigned To Column -->
        <ng-container matColumnDef="assignedTo">
          <th mat-header-cell *matHeaderCellDef>Asignado</th>
          <td mat-cell *matCellDef="let vacancy">
            <span class="assigned-name">{{ vacancy.assignedTo || '-' }}</span>
          </td>
        </ng-container>

        <!-- Source Column -->
        <ng-container matColumnDef="source">
          <th mat-header-cell *matHeaderCellDef>Fuente</th>
          <td mat-cell *matCellDef="let vacancy">{{ getSourceLabel(vacancy.source) }}</td>
        </ng-container>

        <!-- Published Date Column -->
        <ng-container matColumnDef="publishedDate">
          <th mat-header-cell *matHeaderCellDef>Publicado</th>
          <td mat-cell *matCellDef="let vacancy">{{ formatDate(vacancy.publishedDate) }}</td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let vacancy">
            <button
              mat-button
              color="primary"
              (click)="goToDetail(vacancy); $event.stopPropagation()"
            >
              Ver
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let vacancy; columns: displayedColumns"
          (click)="goToDetail(vacancy)"
          class="vacancy-row"
        ></tr>
      </table>

      <!-- Paginator -->
      <mat-paginator
        [length]="totalItems()"
        [pageSize]="pageSize()"
        [pageIndex]="currentPage() - 1"
        [pageSizeOptions]="[25, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons
      >
      </mat-paginator>
    }
  </div>
</div>

<!-- Create Vacancy Modal -->
<app-create-vacancy-modal
  [isOpen]="showCreateModal()"
  (submitCreate)="onCreateVacancy($event)"
  (closeModal)="closeCreateModal()"
/>
