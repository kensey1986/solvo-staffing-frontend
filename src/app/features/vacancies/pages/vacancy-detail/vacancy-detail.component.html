<div class="vacancy-detail-container">
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
    </div>
  } @else if (vacancy(); as vac) {
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <a routerLink="/vacancies" class="breadcrumb-link">Vacantes</a>
      <span class="breadcrumb-separator">›</span>
      <span class="breadcrumb-current">{{ vac.jobTitle }}</span>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
      <div class="page-header-left">
        <h1 class="page-title">{{ vac.jobTitle }}</h1>
        <app-pipeline-badge
          [stage]="vac.pipelineStage"
          [clickable]="true"
          (click)="openStateChangeDialog()"
        />
      </div>
      <div class="page-header-actions">
        <button mat-stroked-button (click)="openEditDialog()">
          <mat-icon>edit</mat-icon>
          Editar
        </button>
      </div>
    </div>

    <!-- Tabs -->
    <mat-tab-group
      [(selectedIndex)]="selectedTabIndex"
      class="detail-tabs"
      animationDuration="200ms"
    >
      <!-- General Tab -->
      <mat-tab label="General">
        <div class="tab-content">
          <!-- Company Card -->
          <div class="info-card">
            <h3 class="card-title">Empresa Asociada</h3>
            <div class="company-row">
              <a [routerLink]="['/companies', vac.companyId]" class="company-link">
                {{ vac.companyName }}
              </a>
              <app-status-badge [status]="'active'" />
            </div>
          </div>

          <!-- Vacancy Info Card -->
          <div class="info-card">
            <h3 class="card-title">Información de la Vacante</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Ubicación</span>
                <span class="info-value">{{ vac.location }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Departamento</span>
                <span class="info-value">{{ vac.department || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Nivel de Seniority</span>
                <span class="info-value">{{ vac.seniorityLevel || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Tipo de Empleo</span>
                <span class="info-value">{{ vac.jobType || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Modalidad de Trabajo</span>
                <span class="info-value">{{ vac.workModality || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Viable Remoto</span>
                <span class="info-value">{{ getRemoteViableText(vac.isRemoteViable) }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Rango Salarial</span>
                <span class="info-value">{{ vac.salaryRange || 'N/A' }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Estado</span>
                <app-status-badge [status]="vac.status" />
              </div>
            </div>
          </div>

          <!-- Source Info Card -->
          <div class="info-card">
            <h3 class="card-title">Información de Origen</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Fuente</span>
                <span class="info-value">{{ sourceLabel() }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">URL Original</span>
                <span class="info-value">
                  @if (vac.jobUrl) {
                    <a [href]="vac.jobUrl" target="_blank" class="external-link">
                      Ver original ↗
                    </a>
                  } @else {
                    N/A
                  }
                </span>
              </div>
              <div class="info-item">
                <span class="info-label">Fecha de Publicación</span>
                <span class="info-value">{{ formatDate(vac.publishedDate) }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Fecha de Detección</span>
                <span class="info-value">{{
                  vac.scrapedAt ? formatDateTime(vac.scrapedAt) : 'N/A'
                }}</span>
              </div>
            </div>
          </div>

          <!-- Notes Card -->
          <div class="info-card">
            <h3 class="card-title">Notas</h3>
            <div class="notes-content">
              {{ vac.notes || 'Sin notas disponibles.' }}
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Tracking Tab -->
      <mat-tab label="Seguimiento">
        <div class="tab-content">
          <div class="info-card">
            <div class="card-header">
              <h3 class="card-title">Historial de Estados</h3>
              <button mat-flat-button color="primary" (click)="openStateChangeDialog()">
                Cambiar Estado
              </button>
            </div>

            @if (stateHistory().length === 0) {
              <div class="empty-state">
                <p>No hay cambios de estado registrados.</p>
              </div>
            } @else {
              <table mat-table [dataSource]="stateHistory()" class="history-table">
                <!-- Date Column -->
                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef>Fecha</th>
                  <td mat-cell *matCellDef="let entry">{{ formatDate(entry.date) }}</td>
                </ng-container>

                <!-- User Column -->
                <ng-container matColumnDef="user">
                  <th mat-header-cell *matHeaderCellDef>Usuario</th>
                  <td mat-cell *matCellDef="let entry">{{ entry.user }}</td>
                </ng-container>

                <!-- Change Column -->
                <ng-container matColumnDef="change">
                  <th mat-header-cell *matHeaderCellDef>Cambio</th>
                  <td mat-cell *matCellDef="let entry" class="change-cell">
                    @if (entry.fromState) {
                      <app-pipeline-badge [stage]="entry.fromState" />
                      <span class="arrow">→</span>
                    }
                    <app-pipeline-badge [stage]="entry.toState" />
                  </td>
                </ng-container>

                <!-- Note Column -->
                <ng-container matColumnDef="note">
                  <th mat-header-cell *matHeaderCellDef>Nota</th>
                  <td mat-cell *matCellDef="let entry" class="note-cell">{{ entry.note }}</td>
                </ng-container>

                <!-- Tags Column -->
                <ng-container matColumnDef="tags">
                  <th mat-header-cell *matHeaderCellDef>Etiquetas</th>
                  <td mat-cell *matCellDef="let entry">
                    <div class="tags-container">
                      @for (tag of entry.tags; track tag) {
                        <span class="tag-chip">{{ tag }}</span>
                      }
                    </div>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: historyColumns"></tr>
              </table>
            }
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>

    <!-- State Change Modal -->
    <app-state-change-modal
      [isOpen]="showStateModal()"
      [currentState]="vacancy()?.pipelineStage"
      [states]="stateOptions()"
      [minNoteLength]="10"
      (submitChange)="onStateChange($event)"
      (closeModal)="closeStateModal()"
    />
  }
</div>
